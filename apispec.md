API仕様
======

以下の5種類のAPIを使用してゲームに参加します。

```
GET /api/master_data
GET /api/game/{token}
GET /api/task/{token}/{t}
GET /api/move/{token}/{idx}-{x}-{y}
GET /api/move_next/{token}/{idx}-{x}-{y}
```

`{token}` は ポータルサイトトップに記載されています。

ビジュアライザは以下のAPIを使用します。ビジュアライザで操作することで、移動APIが使用されることに注意してください。
```
GET /api/move/{token}/{idx}-{x}-{y}
GET /event/{token}
```

`GET /event/{token}` についてのドキュメントは提供しませんが、自作プログラムで使用することを禁止はしません。

---
#### マスタデータ取得API

##### endpoint
```
GET /api/master_data
```

##### response

```js
{
 "game_period": 1000000,  // ゲーム開始から終了までの時間 [単位ミリ秒]
 "max_len_task": 10,  // タスク文字列長の最大値
 "num_agent": 5,  // agentの数
 "checkpoints": [  // チェックポイント情報 (要素数26)
   {"x":14,"y":3},  // x座標とy座標
   ...
 ],
 "area_size": 30  // マップの大きさ
}
```

---
#### ゲーム情報取得API

ゲーム情報取得処理は参加者ごとに1000ミリ秒に1回に制限されます。
サーバは、次のゲーム情報取得処理が可能になるまで処理開始を待ちます。

##### endpoint
```
GET /api/game/{token}
```
- `{token}` : ポータルサイトに記載されているトークン

##### response (成功時)

```js
{
 "status": "ok",
 "now": 12345,  // ゲーム開始からの時間 [単位ミリ秒]
 "agent": [
   {
     "move": [{"x": 2.72, "y": 3.14, "t": 12345}, {"x": 10, "y": 20, "t": 14181}],  // エージェントの移動情報
     "history": "ABC", // nowまで(nowを含む)に到達したチェックポイント一覧 (直近最大max_len_task件)
     "history_times": [7000, 8000, 9000]  // historyに記載されているチェックポイントに到達した時刻
   },
   ...
 ],
 "task": [
   {
     "s": "ABCD",  // タスク文字列
     "t": 0,  // タスク追加時刻 [単位ミリ秒]
     "weight": 1,  // タスクの重み
     "count": 1,  // 自分のnowまで(nowを含む)のタスク達成回数
     "total": 3  // 全体のタスク達成回数。遅延あり
   },
   ...
 ],
 "next_task": 20000  // 次にtaskが追加される時刻 [単位ミリ秒]。存在しない場合は-1
}
```

##### response (失敗時: 処理開始を待っている間に他のゲーム情報取得処理が行われた場合)

```js
{
 "status": "error_time_limit"
}
```

##### response (ゲーム終了時)

```js
{
 "status": "game_finished"
}
```

---
#### タスク情報取得API

タスク情報取得処理は参加者ごとに500ミリ秒に1回に制限されます。
サーバは、次のタスク情報取得が可能になるまで処理開始を待ちます。

要求されたタスク追加時刻まで4秒以内の場合、タスク追加時刻まで待ってからレスポンスを返します。

##### endpoint

```
GET /api/task/{token}/{t}
```

- `{token}` : ポータルサイトに記載されているトークン
- `{t}` : タスク追加時刻 [単位ミリ秒]

##### response (成功時)

```js
{
 "status": "ok",
 "task": [
   {
     "s": "ABCD",  // タスク文字列
     "t": 0,  // タスク追加時刻 [単位ミリ秒]
     "weight": 1,  // タスクの重み
   },
   ...
 ],
 "next_task": 20000  // 次にtaskが追加される時刻 [単位ミリ秒]。存在しない場合は-1
}
```

##### response (失敗時: 処理開始を待っている間に他のゲーム情報取得処理が行われた場合、または、要求されたタスク追加時刻が4秒以上未来である場合)

```js
{
 "status": "error_time_limit"
}
```

##### response (失敗時: 要求されたタスク追加時刻にタスクが存在しない場合)

```js
{
 "status": "error_not_found"
}
```

##### response (ゲーム終了時)

```js
{
 "status": "game_finished"
}
```

---
#### 移動API

移動処理はエージェントごとにmoveとmove_next共通で100ミリ秒に1回に制限されます。
サーバは、次の移動処理が可能になるまで処理開始を待ちます。

即時移動と予約移動の違いについては、[問題概要](PROBLEM.md#即時移動と予約移動)を参照してください。

##### endpoint

```
// 即時移動処理API
GET /api/move/{token}/{idx}-{x}-{y}

// 予約移動処理API
GET /api/move_next/{token}/{idx}-{x}-{y}  
```

- `{token}` : ポータルサイトに記載されているトークン
- `{idx}` : エージェントID (1以上5以下)
- `{x}`, `{y}` : 目標位置 (それぞれ0以上30以下の整数)

##### response (成功時)

```js
{
 "status": "ok",
 "now": 12345,  // ゲーム開始からの時間 [単位ミリ秒]
 "move": [{"x": 2.72, "y": 3.14, "t": 12345}, {"x": 10, "y": 20, "t": 14181}]  // エージェントの移動情報
}
```

##### response (失敗時: 処理開始を待っている間に他の移動処理が行われた場合)

```js
{
 "status": "error_time_limit"
}
```

##### response (ゲーム終了時)

```js
{
 "status": "game_finished"
}
```
